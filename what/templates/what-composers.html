{% extends "what-base.html" %}


{% block title %}
    Browse composers
{% endblock %}


{% block main %}
<div class="columns c15-85">
    <div>a</div>
    <div>
        <div class="pagination">
            <a href="#"  class="prev_page"><</a>
            Page: <span class="current_page">0</span> / <span class="total_page">0</span>
            <a href="#" class="next_page">></a>
            (<span class="results_count">0</span> results)
        </div>
        <c-composer-grid class="disabled"> </c-composer-grid>
    </div>
</div>
{% endblock %}

<!--
<c-composer style="background-image:url('{{composer.portrait}}');">
    <c-composer-infos>
        <div class="name">{{composer.name}}, {{composer.first_name}}</div>
        <div class="infos">#{{composer.id}} - {{composer.works_qty}} works</div>
    </c-composer-infos>
</c-composer>
                -->

{% block javascript %}
    {% csrf_token %}
    <script type="text/javascript">
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const result_per_page = 30;

        // The function to call api
        function load_composers(page = 1){
            // console.log(page);
            let composer_grid = $('c-composer-grid');
            let prev_page = $('.prev_page');
            let next_page = $('.next_page');
            composer_grid.addClass('disabled');
            next_page.addClass('disabled');

            $.ajax({
                url: "{% url 'api-composers' %}",
                headers: {'X-CSRFToken': csrftoken},
                type: "POST",

                dataType: "json",
                data: {
                    'page': page
                },

                success: function(data){
                    console.log(data);


                    let page_max = data.total_count % result_per_page > 0 ?
                                    (data.total_count/result_per_page + 1).toFixed(0) :
                                    (data.total_count/result_per_page);

                    $('.results_count').text(data.total_count);
                    $('.current_page').text(page);
                    $('.total_page').text(page_max);

                    prev_page.off('click');
                    prev_page.click(function(){load_composers(page - 1 > 0 ? page - 1 : 1)});
                    next_page.off('click');
                    next_page.click(function(){load_composers(page + 1 < page_max ? page + 1 : page_max);});

                    composer_grid.empty();

                    for (let i = 0; i < data.page_count ; i++){
                        composer_grid.append(`
                            <c-composer style="background-image:url('`+ data.data[i].portrait +`');">
                                <c-composer-infos>
                                    <div class="name">`+ data.data[i].name +`, `+ data.data[i].first_name +`</div>
                                    <div class="infos">#`+ data.data[i].id +` - `+ data.data[i].works_count +` works</div>
                                </c-composer-infos>
                            </c-composer>
                        `);
                    }

               }
           });

            composer_grid.removeClass('disabled');
            next_page.removeClass('disabled');
            prev_page.removeClass('disabled');
        }

        $(document).ready(function() {
           load_composers();
        });
    </script>
{% endblock %}